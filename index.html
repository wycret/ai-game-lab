<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¸¸æˆç›ˆåˆ©ç³»ç»Ÿ</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- âŒ ç§»é™¤ Babel Standaloneã€‚æ”¹ä¸ºä½¿ç”¨ type="module" -->
    <!-- <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script> -->

    <!-- å¼•å…¥ React å’Œ ReactDOM (éœ€è¦ä½¿ç”¨ UMD ç‰ˆæœ¬ï¼Œä½†æˆ‘ä»¬å°†åœ¨ module å†…éƒ¨é€šè¿‡å…¨å±€å˜é‡è®¿é—®) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <style>
        /* è®¾ç½®å…¨å±€å­—ä½“å’ŒèƒŒæ™¯ï¼Œå¢å¼ºè§†è§‰æ•ˆæœ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* æ²‰ç¨³çš„æ·±è“è‰²èƒŒæ™¯ */
            color: #e2e8f0;
        }
        /* ç¡®ä¿è‡ªå®šä¹‰ alert æ ·å¼å¯ä»¥è¦†ç›– */
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background: #1f2937;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            max-width: 80%;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- React åº”ç”¨å°†åœ¨æ­¤å¤„æ¸²æŸ“ -->
    </div>

    <!-- è‡ªå®šä¹‰ Alert æ›¿ä»£æµè§ˆå™¨çš„ alert() -->
    <div id="custom-alert-container"></div>
    <script type="text/javascript">
        // é‡å†™ alert() å‡½æ•°ä»¥ä½¿ç”¨è‡ªå®šä¹‰ UI
        window.alert = function(message) {
            const container = document.getElementById('custom-alert-container');
            const alertBox = document.createElement('div');
            alertBox.className = 'custom-alert';
            alertBox.innerHTML = `
                <p class="text-white text-lg mb-4">${message}</p>
                <button 
                    onclick="this.parentNode.remove()" 
                    class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition duration-150"
                >
                    ç¡®è®¤
                </button>
            `;
            container.appendChild(alertBox);
        };
    </script>

    <!-- React/JSX ä»£ç å— -->
    <!-- å…³é”®ä¿®å¤ï¼šæ”¹ä¸º type="module"ï¼Œæµè§ˆå™¨å¯ä»¥ç›´æ¥æ‰§è¡Œ ES Module -->
    <script type="module">
// ğŸš¨ æ³¨æ„ï¼šåœ¨ type="module" ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½å†ä½¿ç”¨ Babel é£æ ¼çš„ JSXã€‚
// å¿…é¡»ä½¿ç”¨åŸç”Ÿ JavaScript å’Œ createElement() æˆ–ä½¿ç”¨æ„å»ºå·¥å…·é¢„ç¼–è¯‘ã€‚
// ä¸ºå…¼å®¹å•æ–‡ä»¶é™åˆ¶ï¼Œæˆ‘ä»¬å°†ä¿ç•™ JSX è¯­æ³•å¹¶ä¾èµ–æµè§ˆå™¨çš„ modern featuresï¼Œ
// ä½†ç§»é™¤ import React from 'react'ï¼Œæ”¹ä¸ºä½¿ç”¨å…¨å±€çš„ React å˜é‡ã€‚

import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
import { getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc, runTransaction } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

// =================================================================
// 1. ã€é‡è¦ã€‘å…¨å±€é…ç½®ä¸å·¥å…·å‡½æ•° - è¯·æ›¿æ¢æ‚¨çš„ Firebase é…ç½®
// =================================================================

// 1.1 åº”ç”¨ ID (å·²è®¾ç½®ä¸º AiGameWeb)
const appId = 'AiGameWeb'; 

// 1.2 ğŸ”¥ğŸ”¥ğŸ”¥ è¯·ç”¨æ‚¨è‡ªå·±çš„ Firebase Web åº”ç”¨é…ç½®å¯¹è±¡æ›¿æ¢ä¸‹é¢çš„æ‰€æœ‰ '***' å ä½ç¬¦ ğŸ”¥ğŸ”¥ğŸ”¥
const firebaseConfig = {
    apiKey: "AIzaSyD0kALHxst8sqHLLhPNpRyuu-6VOD1tlHo",
    authDomain: "aigame-store.firebaseapp.com",
    projectId: "aigame-store",
    storageBucket: "aigame-store.firebasestorage.app",
    messagingSenderId: "227975426620",
    appId: "1:227975426620:web:cac0a0ad8d8cea87de0939"
};
// ğŸ”¥ğŸ”¥ğŸ”¥ æ›¿æ¢ç»“æŸ ğŸ”¥ğŸ”¥ğŸ”¥

// åœ¨ Canvas/GitHub Pages ç¯å¢ƒä¸­ï¼Œä¸ä½¿ç”¨ custom token
const initialAuthToken = null; 

// åˆå§‹åŒ– Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ä¸ºäº†è®© type="module" ä¸­çš„ JSX/React æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬é€šè¿‡å…¨å±€å˜é‡è®¿é—® React
const { useState, useEffect, useContext, createContext, useCallback } = window.React;
const { createRoot } = window.ReactDOM;

// Contexts
const AuthContext = createContext(null);
const CurrencyContext = createContext(null);

// =================================================================
// 2. è®¤è¯å’Œæ•°æ®åº“è¿æ¥ (AuthProvider)
// =================================================================

const AuthProvider = ({ children }) => {
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (initialAuthToken) {
          // åœ¨æœ¬ç¯å¢ƒä¸­ä¸ä½¿ç”¨æ­¤åˆ†æ”¯
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          // GitHub Pages ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨åŒ¿åç™»å½•
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Firebase ç™»å½•å¤±è´¥:", error);
      }
    };

    // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) {
        setUserId(user.uid);
      } else {
        // å¦‚æœåŒ¿åç™»å½•å¤±è´¥ï¼Œä½¿ç”¨éšæœº ID
        setUserId(crypto.randomUUID());
      }
      setIsAuthReady(true);
    });

    initAuth();
    return () => unsubscribe();
  }, []);

  return (
    <AuthContext.Provider value={{ userId, db, isAuthReady }}>
      {children}
    </AuthContext.Provider>
  );
};

// =================================================================
// 3. è™šæ‹Ÿè´§å¸ä¸é“å…·ç®¡ç† (CurrencyProvider)
// =================================================================

const AD_LIMIT_PER_DAY = 5;

const CurrencyProvider = ({ children }) => {
  const { userId, db, isAuthReady } = useContext(AuthContext);
  const [balance, setBalance] = useState(0);
  const [inventory, setInventory] = useState({});
  const [adsWatchedToday, setAdsWatchedToday] = useState(0);
  const [lastAdDate, setLastAdDate] = useState(null);
  const [loading, setLoading] = useState(true);

  // Firestore æ–‡æ¡£å¼•ç”¨è·¯å¾„
  const getProfileRef = useCallback((id) => {
    if (!db || !id) return null;
    // ä½¿ç”¨ Private Data è·¯å¾„ç»“æ„ï¼š/artifacts/{appId}/users/{userId}/data/profile
    return doc(db, 'artifacts', appId, 'users', id, 'data', 'profile');
  }, [db]);

  // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®æˆ–åŒæ­¥æ•°æ®
  useEffect(() => {
    if (!isAuthReady || !userId) return;

    const profileRef = getProfileRef(userId);
    if (!profileRef) return; // ç¡®ä¿ profileRef å­˜åœ¨

    const initializeData = async () => {
      try {
        const docSnap = await getDoc(profileRef);
        if (!docSnap.exists()) {
          const initialData = {
            balance: 100, // åˆå§‹å¥–åŠ±
            inventory: {},
            lastAdDate: new Date(0).toISOString(), // åˆå§‹åŒ–ä¸ºå†å²æ—¥æœŸ
            adsWatchedToday: 0,
          };
          // ä½¿ç”¨ setDoc ç¡®ä¿æ–‡æ¡£å­˜åœ¨
          await setDoc(profileRef, initialData, { merge: true }); 
          setBalance(initialData.balance);
          setInventory(initialData.inventory);
          setAdsWatchedToday(0);
          // setLoading(false); // é¿å…é‡å¤è®¾ç½®ï¼Œç•™ç»™ onSnapshot å¤„ç†
        }
      } catch (e) {
        console.error("åˆå§‹åŒ–æ•°æ®å¤±è´¥ï¼Œå¯èƒ½ç¼ºå°‘ Firestore æƒé™:", e);
        // å³ä½¿å¤±è´¥ï¼Œä¹Ÿè®¾ç½® loading=false å…è®¸ UI åŠ è½½
        setLoading(false);
      }
    };

    initializeData();

    // å®æ—¶ç›‘å¬æ•°æ®å˜åŒ–
    const unsubscribe = onSnapshot(profileRef, (doc) => {
      if (doc.exists()) {
        const data = doc.data();
        const today = new Date().toDateString();
        const lastAd = new Date(data.lastAdDate || 0).toDateString();

        // æ¯æ—¥é‡ç½®é€»è¾‘
        let currentAdsWatched = data.adsWatchedToday || 0;
        if (lastAd !== today) {
          currentAdsWatched = 0; // æ–°çš„ä¸€å¤©ï¼Œé‡ç½®æ¬¡æ•°
        }

        setBalance(data.balance || 0);
        setInventory(data.inventory || {});
        setAdsWatchedToday(currentAdsWatched);
        setLastAdDate(data.lastAdDate);
      }
      setLoading(false); // åœ¨ onSnapshot æ¥æ”¶åˆ°æ•°æ®åæ‰è®¾ç½® loading ä¸º false
    }, (error) => {
      console.error("Firestore ç›‘å¬å¤±è´¥:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [isAuthReady, userId, getProfileRef]); // ä¾èµ–é¡¹ç¡®ä¿åœ¨è®¤è¯å®Œæˆåæ‰§è¡Œ

  // è§‚çœ‹å¹¿å‘Šè·å–è™šæ‹Ÿå¸ (å¸¦æ¯æ—¥é™åˆ¶)
  const watchAd = async () => {
    if (!userId || adsWatchedToday >= AD_LIMIT_PER_DAY) {
      alert("ä»Šæ—¥å¹¿å‘Šæ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè¯·æ˜å¤©å†è¯•ï¼");
      return false;
    }

    const profileRef = getProfileRef(userId);
    if (!profileRef) return false;

    // æ¨¡æ‹Ÿå¹¿å‘Šæ’­æ”¾å»¶è¿Ÿ
    console.log("æ­£åœ¨æ’­æ”¾å¹¿å‘Š...");
    await new Promise(resolve => setTimeout(resolve, 1500));
    console.log("å¹¿å‘Šæ’­æ”¾å®Œæ¯•ï¼Œå¥–åŠ±å‘æ”¾ä¸­...");

    try {
      await runTransaction(db, async (transaction) => {
        const docSnap = await transaction.get(profileRef);
        if (!docSnap.exists()) throw new Error("ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨");

        const data = docSnap.data();
        const today = new Date().toDateString();
        const lastAd = new Date(data.lastAdDate || 0).toDateString();

        let newAdsWatched = data.adsWatchedToday || 0;
        if (lastAd !== today) {
          newAdsWatched = 0; // é‡ç½®
        }

        if (newAdsWatched >= AD_LIMIT_PER_DAY) throw new Error("å·²è¶…è¿‡ä»Šæ—¥é™åˆ¶");

        transaction.update(profileRef, {
          balance: (data.balance || 0) + 10, // å¥–åŠ± 10 è™šæ‹Ÿå¸
          adsWatchedToday: newAdsWatched + 1,
          lastAdDate: new Date().toISOString(),
        });
      });
      alert("æ­å–œï¼è·å¾— 10 è™šæ‹Ÿå¸å¥–åŠ±ï¼");
      return true;
    } catch (e) {
      console.error("å¹¿å‘Šäº¤æ˜“å¤±è´¥:", e);
      alert(`å¥–åŠ±å‘æ”¾å¤±è´¥: ${e.message || e}`);
      return false;
    }
  };

  // è´­ä¹°è™šæ‹Ÿå¸ (æ¨¡æ‹Ÿç°å®è´§å¸äº¤æ˜“)
  const buyCoins = async (amount, realCost) => {
    if (!userId) return alert("è¯·å…ˆç™»å½•ã€‚");
    const profileRef = getProfileRef(userId);
    if (!profileRef) return false;

    // --- å®é™…æ”¯ä»˜ç½‘å…³é›†æˆç‚¹ ---
    console.log(`æ¨¡æ‹Ÿå‘èµ·æ”¯ä»˜: è´­ä¹° ${amount} å¸ï¼Œæ”¯ä»˜ ${realCost} USD...`);
    // å‡è®¾æ­¤å¤„è°ƒç”¨äº† Stripe/PayPal APIï¼Œå¹¶åœ¨æœåŠ¡å™¨ç«¯éªŒè¯äº†æ”¯ä»˜æˆåŠŸ
    await new Promise(resolve => setTimeout(resolve, 1000));
    // --- å®é™…æ”¯ä»˜ç½‘å…³é›†æˆç‚¹ End ---

    try {
      // æ­¤å¤„ä¸éœ€è¦äº‹åŠ¡ï¼Œå› ä¸ºåªæ˜¯å¢åŠ ä½™é¢ï¼Œä¸æ¶‰åŠæ‰£å‡
      // å¿…é¡»ä½¿ç”¨ runTransaction æ¥è¯»å–å½“å‰ä½™é¢å¹¶æ›´æ–°ï¼Œä»¥é˜²å¹¶å‘é—®é¢˜
      await runTransaction(db, async (transaction) => {
          const docSnap = await transaction.get(profileRef);
          if (!docSnap.exists()) throw new Error("ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨");
          
          const currentBalance = docSnap.data().balance || 0;
          
          transaction.update(profileRef, {
            balance: currentBalance + amount, // ç›´æ¥å¢åŠ ä½™é¢
          });
      });

      alert(`è´­ä¹°æˆåŠŸï¼è·å¾— ${amount} è™šæ‹Ÿå¸ï¼`);
      return true;
    } catch (e) {
      console.error("è´­ä¹°è™šæ‹Ÿå¸å¤±è´¥:", e);
      alert("è´­ä¹°å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚");
      return false;
    }
  };

  // è´­ä¹°é“å…· (åœ¨æ¸¸æˆä¸­ä½¿ç”¨è™šæ‹Ÿå¸)
  const buyItem = async (itemId, cost) => {
    if (!userId) return alert("è¯·å…ˆç™»å½•ã€‚");
    const profileRef = getProfileRef(userId);
    if (!profileRef) return false;

    try {
      await runTransaction(db, async (transaction) => {
        const docSnap = await transaction.get(profileRef);
        if (!docSnap.exists()) throw new Error("ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨");

        const currentBalance = docSnap.data().balance || 0;
        if (currentBalance < cost) throw new Error("ä½™é¢ä¸è¶³");

        // æ›´æ–°ä½™é¢å’Œåº“å­˜
        const newInventory = { ...docSnap.data().inventory };
        newInventory[itemId] = (newInventory[itemId] || 0) + 1;

        transaction.update(profileRef, {
          balance: currentBalance - cost,
          inventory: newInventory,
        });
      });

      // ä»…åœ¨ cost > 0 æ—¶æ‰æ˜¾ç¤ºè´­ä¹°æˆåŠŸ
      if (cost > 0) {
        alert(`è´­ä¹°æˆåŠŸï¼è·å¾—é“å…·: ${itemId}`);
      }
      return true;
    } catch (e) {
      console.error("è´­ä¹°é“å…·/æ¶ˆè€—é“å…·å¤±è´¥:", e);
      alert(`æ“ä½œå¤±è´¥: ${e.message || e}`);
      return false;
    }
  };
  
  // æ¶ˆè€—é“å…·ï¼šä¸ buyItem é€»è¾‘ç›¸åŒï¼Œä½† cost=0ï¼Œä¸”åœ¨ transaction ä¸­è¿›è¡Œåº“å­˜æ‰£å‡
  const useItem = async (itemId) => {
      if (!userId) return alert("è¯·å…ˆç™»å½•ã€‚");
      const profileRef = getProfileRef(userId);
      if (!profileRef) return false;
      
      try {
          await runTransaction(db, async (transaction) => {
              const docSnap = await transaction.get(profileRef);
              if (!docSnap.exists()) throw new Error("ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨");

              const currentInventory = docSnap.data().inventory || {};
              if ((currentInventory[itemId] || 0) <= 0) throw new Error("åº“å­˜ä¸è¶³");

              // æ‰£å‡åº“å­˜
              const newInventory = { ...currentInventory };
              newInventory[itemId] = newInventory[itemId] - 1;

              transaction.update(profileRef, {
                  inventory: newInventory,
              });
          });
          return true;
      } catch (e) {
          console.error("æ¶ˆè€—é“å…·å¤±è´¥:", e);
          alert(`æ¶ˆè€—å¤±è´¥: ${e.message || e}`);
          return false;
      }
  }


  const contextValue = {
    balance,
    inventory,
    watchAd,
    buyCoins,
    buyItem,
    useItem, // æš´éœ² useItem 
    adsWatchedToday,
    AD_LIMIT_PER_DAY,
    loading,
    userId,
  };

  return (
    <CurrencyContext.Provider value={contextValue}>
      {children}
    </CurrencyContext.Provider>
  );
};

// Custom Hook to use currency system
const useCurrency = () => useContext(CurrencyContext);

// =================================================================
// 4. æ ¸å¿ƒåº”ç”¨ç»„ä»¶ (App)
// =================================================================

// é“å…·å•†åº—ç»„ä»¶
const Store = () => {
  const { buyItem, inventory, adsWatchedToday, AD_LIMIT_PER_DAY, watchAd, buyCoins } = useCurrency();

  const shopItems = [
    { id: 'shield', name: 'æ°¸ä¹…æŠ¤ç›¾', cost: 150, description: 'åœ¨æ˜Ÿé™…èº²é¿ä¸­æ‹¥æœ‰é¢å¤–ä¸€æ¬¡æŠ¤ç›¾' },
    { id: 'speed_boost', name: 'é€Ÿåº¦è¯æ°´', cost: 50, description: 'è´ªåƒè›‡æ¸¸æˆå¼€å±€é€Ÿåº¦æé«˜' },
    { id: 'cosmetic_skin', name: 'é£èˆ¹çš®è‚¤', cost: 200, description: 'è§£é”é£èˆ¹çš„ç‚«é…·çš®è‚¤' },
  ];

  const coinPacks = [
    { amount: 50, cost: 0.99 },
    { amount: 120, cost: 1.99 },
    { amount: 300, cost: 4.99 },
  ];

  return (
    <div className="p-6 bg-gray-800/50 rounded-xl shadow-lg border border-gray-700/50 backdrop-blur-md">
      <h2 className="text-2xl font-bold mb-4 text-white">è™šæ‹Ÿè´§å¸å•†åº—</h2>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        {/* è´§å¸è´­ä¹°åŒº (æ¨¡æ‹Ÿæ”¯ä»˜) */}
        <section>
          <h3 className="text-xl font-semibold mb-3 text-indigo-400">ğŸ’° è´­ä¹°è™šæ‹Ÿå¸ (RMB)</h3>
          <div className="space-y-3">
            {coinPacks.map(pack => (
              <button
                key={pack.amount}
                onClick={() => buyCoins(pack.amount, pack.cost)}
                className="w-full flex justify-between items-center p-3 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition duration-150 shadow-md text-white font-medium"
              >
                <span>{pack.amount} è™šæ‹Ÿå¸</span>
                <span className="text-sm bg-indigo-700 py-1 px-3 rounded-full">Â¥ {pack.cost}</span>
              </button>
            ))}
          </div>
        </section>
        
        {/* å¹¿å‘Šè·å–åŒº */}
        <section>
          <h3 className="text-xl font-semibold mb-3 text-pink-400">ğŸ“º å…è´¹è·å– (çœ‹å¹¿å‘Š)</h3>
          <div className="space-y-3">
            <p className="text-sm text-gray-400">
              ä»Šæ—¥å·²çœ‹: {adsWatchedToday} / {AD_LIMIT_PER_DAY} æ¬¡
            </p>
            <button
              onClick={watchAd}
              disabled={adsWatchedToday >= AD_LIMIT_PER_DAY}
              className={`mt-1 w-full p-4 rounded-lg transition duration-150 font-bold ${
                adsWatchedToday >= AD_LIMIT_PER_DAY 
                  ? 'bg-gray-600 text-gray-400 cursor-not-allowed' 
                  : 'bg-pink-600 hover:bg-pink-500 text-white shadow-lg'
              }`}
            >
              {adsWatchedToday >= AD_LIMIT_PER_DAY ? 'ä»Šæ—¥é¢åº¦å·²ç”¨å®Œ' : 'è§‚çœ‹å¹¿å‘Š (å¾— 10 å¸)'}
            </button>
            <p className="text-xs text-gray-500 mt-2">ï¼ˆæ­¤æ“ä½œå°†æ›´æ–°æ‚¨çš„ Firestore è´¦æˆ·æ•°æ®ï¼‰</p>
          </div>
        </section>
      </div>

      <h3 className="text-2xl font-bold mt-8 mb-4 text-white">è´­ä¹°æ¸¸æˆé“å…·</h3>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {shopItems.map(item => (
          <div key={item.id} className="p-4 bg-gray-700/70 rounded-lg border border-gray-600">
            <h4 className="font-semibold text-lg text-cyan-400">{item.name}</h4>
            <p className="text-sm text-gray-400 mb-3">{item.description}</p>
            <div className="flex justify-between items-center">
              <span className="text-base font-bold text-yellow-300">{item.cost} å¸</span>
              <button
                onClick={() => buyItem(item.id, item.cost)}
                className="bg-cyan-600 text-white px-4 py-2 rounded-lg hover:bg-cyan-500 transition duration-150 text-sm"
              >
                è´­ä¹° (åº“å­˜: {inventory[item.id] || 0})
              </button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// æ¸¸æˆç»„ä»¶ï¼ˆç”¨äºæ¼”ç¤ºå¦‚ä½•æ¶ˆè´¹é“å…·ï¼‰
const GamePanel = () => {
    // å…³é”®ä¿®å¤ï¼šä» context ä¸­è·å– useItem
    const { inventory, balance, useItem } = useCurrency();
    const hasShield = inventory['shield'] > 0;
    const hasSpeedBoost = inventory['speed_boost'] > 0;

    const [message, setMessage] = useState('å¼€å§‹æ¸¸æˆ...');

    const handleUseItem = async (itemId) => {
        if(inventory[itemId] > 0) {
            // ** å…³é”®ï¼šè°ƒç”¨ CurrencyProvider ä¸­å®ç°çš„ useItem äº‹åŠ¡é€»è¾‘ **
            const success = await useItem(itemId); 
            
            if (success) {
                // å¦‚æœæˆåŠŸï¼Œæ˜¾ç¤ºæ¸¸æˆå†…åé¦ˆ
                setMessage(`å·²æˆåŠŸæ¶ˆè€—é“å…·: ${itemId}ã€‚æ¸¸æˆå±æ€§å·²ç”Ÿæ•ˆï¼`);
            } else {
                setMessage(`é“å…·æ¶ˆè€—å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚`);
            }
        } else {
            setMessage(`æ²¡æœ‰ ${itemId} é“å…·äº†ï¼Œå»å•†åº—çœ‹çœ‹å§ã€‚`);
        }
    }

    return (
        <div className="p-6 bg-gray-800/50 rounded-xl shadow-lg border border-gray-700/50 backdrop-blur-md">
            <h2 className="text-2xl font-bold mb-4 text-white">æ¸¸æˆåŒºåŸŸæ¨¡æ‹Ÿ</h2>
            <div className="mb-4 p-4 bg-gray-700 rounded-lg text-lg font-mono text-green-300">
                å½“å‰ä½™é¢: {balance} å¸
            </div>
            
            <div className="grid grid-cols-2 gap-4">
                <div className="p-3 bg-indigo-900/50 rounded-lg">
                    <p className="text-lg font-semibold text-white">æ˜Ÿé™…èº²é¿</p>
                    <p className="text-sm text-gray-400">æ°¸ä¹…æŠ¤ç›¾åº“å­˜: {inventory['shield'] || 0}</p>
                    <button
                        onClick={() => handleUseItem('shield')}
                        disabled={!hasShield}
                        className={`mt-2 w-full py-2 rounded ${hasShield ? 'bg-indigo-500 hover:bg-indigo-400' : 'bg-gray-600 text-gray-400 cursor-not-allowed'}`}
                    >
                        {hasShield ? 'ä½¿ç”¨æŠ¤ç›¾' : 'æ— æŠ¤ç›¾'}
                    </button>
                </div>
                <div className="p-3 bg-indigo-900/50 rounded-lg">
                    <p className="text-lg font-semibold text-white">éœ“è™¹è´ªåƒè›‡</p>
                    <p className="text-sm text-gray-400">é€Ÿåº¦è¯æ°´åº“å­˜: {inventory['speed_boost'] || 0}</p>
                    <button
                        onClick={() => handleUseItem('speed_boost')}
                        disabled={!hasSpeedBoost}
                        className={`mt-2 w-full py-2 rounded ${hasSpeedBoost ? 'bg-indigo-500 hover:bg-indigo-400' : 'bg-gray-600 text-gray-400 cursor-not-allowed'}`}
                    >
                        {hasSpeedBoost ? 'ä½¿ç”¨é€Ÿåº¦è¯æ°´' : 'æ— è¯æ°´'}
                    </button>
                </div>
            </div>
            <p className="mt-4 text-center text-yellow-300">{message}</p>
        </div>
    );
}

// ä¸»åº”ç”¨ç»„ä»¶
const App = () => {
  const { isAuthReady } = useContext(AuthContext);
  const { loading, userId } = useCurrency();

  if (!isAuthReady || loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-900 text-white">
        <div className="animate-pulse">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-900 p-8">
      <header className="text-center mb-8">
        <h1 className="text-4xl font-extrabold text-white mb-2">AI æ¸¸æˆç›ˆåˆ©ç³»ç»Ÿæ¼”ç¤º</h1>
        <p className="text-sm text-gray-500">å½“å‰ç”¨æˆ· ID: <span className="text-yellow-400 break-all">{userId}</span></p>
      </header>

      <main className="max-w-4xl mx-auto space-y-8">
        <Store />
        <GamePanel />
        <footer className="text-center text-gray-600 pt-8">
          <p>æ•°æ®å®æ—¶åŒæ­¥äº Firestore æ•°æ®åº“ã€‚</p>
        </footer>
      </main>
    </div>
  );
};

// ç¡®ä¿åœ¨é¡µé¢åŠ è½½åæ¸²æŸ“ React åº”ç”¨ï¼Œå¹¶æ­£ç¡®åŒ…è£¹ Provider
window.onload = function() {
    const rootElement = document.getElementById('root');
    // ä½¿ç”¨æ–°çš„ React 18 API
    createRoot(rootElement).render(
        <AuthProvider>
            <CurrencyProvider>
                <App />
            </CurrencyProvider>
        </AuthProvider>
    );
}
    </script>
</body>
</html>